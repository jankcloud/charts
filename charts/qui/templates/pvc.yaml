{{- $persistence := .Values.persistence | default dict }}
{{- $configPersistence := $persistence.config | default dict }}
{{- $additionalVolumes := .Values.additionalVolumes | default list }}
{{- if ($configPersistence.enabled | default false) }}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ include "qui.fullname" . }}-config
  labels:
    {{- include "qui.labels" . | nindent 4 }}
spec:
  accessModes:
    - {{ $configPersistence.accessMode | default "ReadWriteOnce" }}
  {{- with $configPersistence.storageClass }}
  storageClassName: {{ . }}
  {{- end }}
  {{- if $configPersistence.volumeName }}
  volumeName: {{ $configPersistence.volumeName }}
  {{- end }}
  resources:
    requests:
      storage: {{ $configPersistence.size | default "2Gi" }}
{{- end }}
{{- range $volume := $additionalVolumes }}
{{- $volumeName := required "additionalVolumes[].name is required" $volume.name }}
{{- $existingClaim := $volume.existingClaim | default "" }}
{{- $volumePvc := $volume.pvc | default dict }}
{{- if not $existingClaim }}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ include "qui.fullname" $ }}-{{ $volumeName }}
  labels:
    {{- include "qui.labels" $ | nindent 4 }}
spec:
  accessModes:
    - {{ $volumePvc.accessMode | default "ReadWriteMany" }}
  {{- with $volumePvc.storageClass }}
  storageClassName: {{ . }}
  {{- end }}
  {{- if $volumePvc.volumeName }}
  volumeName: {{ $volumePvc.volumeName }}
  {{- end }}
  resources:
    requests:
      storage: {{ $volumePvc.size | default "1Ti" }}
{{- end }}
{{- end }}
