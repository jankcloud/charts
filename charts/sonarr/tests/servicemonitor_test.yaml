suite: ServiceMonitor
templates:
  - templates/servicemonitor.yaml
tests:

  # ---------------------------------------------------------------------------
  # arr-common smoke: disabled by default
  # ---------------------------------------------------------------------------
  - it: does not render a ServiceMonitor by default
    asserts:
      - hasDocuments:
          count: 0

  # ---------------------------------------------------------------------------
  # arr-common smoke: basic ServiceMonitor
  # ---------------------------------------------------------------------------
  - it: renders a monitoring.coreos.com/v1 ServiceMonitor when enabled
    set:
      serviceMonitor:
        enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ServiceMonitor
      - isAPIVersion:
          of: monitoring.coreos.com/v1

  - it: uses the release name for the ServiceMonitor name
    set:
      serviceMonitor:
        enabled: true
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-sonarr

  - it: selector matches the sonarr pods
    set:
      serviceMonitor:
        enabled: true
    asserts:
      - isSubset:
          path: spec.selector.matchLabels
          content:
            app.kubernetes.io/name: sonarr
            app.kubernetes.io/instance: RELEASE-NAME

  - it: scrapes the http endpoint with default interval and timeout
    set:
      serviceMonitor:
        enabled: true
    asserts:
      - equal:
          path: spec.endpoints[0].port
          value: http
      - equal:
          path: spec.endpoints[0].interval
          value: 30s
      - equal:
          path: spec.endpoints[0].scrapeTimeout
          value: 10s

  - it: respects custom interval and scrapeTimeout
    set:
      serviceMonitor:
        enabled: true
        interval: 60s
        scrapeTimeout: 20s
    asserts:
      - equal:
          path: spec.endpoints[0].interval
          value: 60s
      - equal:
          path: spec.endpoints[0].scrapeTimeout
          value: 20s

  - it: applies extra labels to the ServiceMonitor
    set:
      serviceMonitor:
        enabled: true
        labels:
          prometheus: kube-prometheus
    asserts:
      - equal:
          path: metadata.labels["prometheus"]
          value: kube-prometheus

  - it: applies annotations to the ServiceMonitor
    set:
      serviceMonitor:
        enabled: true
        annotations:
          argocd.argoproj.io/sync-wave: "5"
    asserts:
      - equal:
          path: 'metadata.annotations["argocd.argoproj.io/sync-wave"]'
          value: "5"

  # ---------------------------------------------------------------------------
  # arr-common smoke: exportarr endpoint absent without exportarr
  # ---------------------------------------------------------------------------
  - it: has only one endpoint when exportarr is disabled
    set:
      serviceMonitor:
        enabled: true
    asserts:
      - lengthEqual:
          path: spec.endpoints
          count: 1
      - notContains:
          path: spec.endpoints
          content:
            port: exportarr
          any: true

  # ---------------------------------------------------------------------------
  # arr-common smoke: exportarr endpoint added when both are enabled
  # ---------------------------------------------------------------------------
  - it: adds an exportarr endpoint when exportarr and serviceMonitor are both enabled
    set:
      serviceMonitor:
        enabled: true
        interval: 30s
        scrapeTimeout: 10s
      exportarr:
        enabled: true
        port: 9707
        image:
          repository: ghcr.io/onedr0p/exportarr
          tag: v2.0.1
          pullPolicy: IfNotPresent
        env:
          URL: "http://localhost:8989"
          APIKEY: "abc123"
    asserts:
      - lengthEqual:
          path: spec.endpoints
          count: 2
      - equal:
          path: spec.endpoints[1].port
          value: exportarr
      - equal:
          path: spec.endpoints[1].interval
          value: 30s
      - equal:
          path: spec.endpoints[1].scrapeTimeout
          value: 10s
